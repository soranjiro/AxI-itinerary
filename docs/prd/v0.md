# AxI-itinerary 詳細設計ドキュメント v0

## 1. プロジェクト概要

### 1.1 プロジェクト名
**AxI-itinerary** - AIと一緒に育てる、みんなの旅日記

### 1.2 開発目的
LLM（大規模言語モデル）を旅のパートナーとして活用し、計画段階から旅行中までユーザーをサポートする、動的でインタラクティブな旅行計画Webアプリケーションの開発

### 1.3 システム特徴
- アカウント登録不要でアクセス可能
- リアルタイム共同編集機能
- LLMとの対話による旅行計画支援
- レスポンシブデザインによる全デバイス対応
- エッジコンピューティングによる高速レスポンス

---

## 2. 機能要件詳細

### 2.1 しおり管理機能

#### 2.1.1 しおり新規作成
- **機能概要**: 推測困難なURLを自動生成してしおりを新規作成
- **詳細仕様**:
  - UUID v4を使用した一意なしおりID生成
  - URL形式: `https://axi-itinerary.app/itinerary/{uuid}`
  - 作成時に編集パスワードの設定（任意）
  - 初期データとして空のタイムライン、持ち物リスト、予算情報を生成

#### 2.1.2 しおりアクセス制御
- **閲覧権限**: URLを知っている全てのユーザー
- **編集権限**: 編集パスワードを知っているユーザーのみ
- **パスワード要件**:
  - 最小4文字、最大20文字
  - 英数字・記号使用可能
  - bcryptによるハッシュ化でDB保存

### 2.2 タイムライン管理機能

#### 2.2.1 予定項目の構造
各予定項目は以下の情報を持つ：
- **ID**: UUID v4による一意識別子
- **日時**: 開始日時（必須）、終了日時（任意）
- **場所**: 場所名（必須）、住所（任意）、GPS座標（任意）
- **タイトル**: 予定のタイトル（必須、最大100文字）
- **詳細**: 予定の詳細説明（任意、最大1000文字）
- **予算**: 個別予算金額（任意）
- **メモ**: 自由記入メモ（任意、最大500文字）
- **作成者**: 作成したユーザーの識別情報
- **更新日時**: 最終更新タイムスタンプ

#### 2.2.2 予定操作機能
- **追加**: 新規予定項目の作成
- **編集**: 既存予定項目の修正
- **削除**: 予定項目の削除（論理削除）
- **並び替え**: ドラッグ&ドロップによる順序変更
- **複製**: 既存予定の複製作成

#### 2.2.3 表示・フィルタリング機能
- **時系列表示**: 日時順での予定一覧表示
- **日別表示**: 日付ごとのグループ表示
- **場所別表示**: 場所ごとのグループ表示
- **検索機能**: タイトル・場所・メモでの部分一致検索

### 2.3 持ち物リスト機能

#### 2.3.1 持ち物項目の構造
- **ID**: UUID v4による一意識別子
- **アイテム名**: 持ち物の名称（必須、最大50文字）
- **カテゴリ**: 分類（衣類、電子機器、書類など）
- **数量**: 必要数量（任意、デフォルト1）
- **チェック状態**: 準備完了フラグ（boolean）
- **メモ**: 補足情報（任意、最大200文字）
- **担当者**: 準備担当者（任意）

#### 2.3.2 持ち物操作機能
- **追加**: 新規アイテムの追加
- **編集**: 既存アイテムの修正
- **削除**: アイテムの削除
- **チェック**: 準備完了の切り替え
- **カテゴリ分類**: 自動・手動でのカテゴリ設定

#### 2.3.3 持ち物管理機能
- **進捗表示**: チェック済み / 全体の進捗率表示
- **カテゴリ別表示**: カテゴリごとのグループ表示
- **担当者別表示**: 担当者ごとの割り当て表示

### 2.4 費用計算機能

#### 2.4.1 予算項目の構造
- **ID**: UUID v4による一意識別子
- **カテゴリ**: 交通費、宿泊費、食費、観光費、その他
- **項目名**: 具体的な費用項目名（必須）
- **予算額**: 予定金額（任意）
- **実費**: 実際の支出金額（任意）
- **支払者**: 支払いを行った人（任意）
- **分割方法**: 個人負担、等分、カスタム分割
- **日付**: 支出予定日または実際の支出日

#### 2.4.2 予算管理機能
- **予算設定**: カテゴリ別予算上限の設定
- **実費記録**: 実際の支出の記録
- **予算対比**: 予算と実費の比較表示
- **カテゴリ別集計**: 支出のカテゴリ別集計
- **個人別集計**: 参加者別の支出・負担額集計

#### 2.4.3 分割計算機能
- **等分分割**: 全参加者での等額分割
- **カスタム分割**: 項目ごとの負担者・負担額指定（直感的なUI）
  - ドラッグ&ドロップによる負担額調整
  - スライダーでの負担比率設定
  - 金額直接入力での個別指定
- **清算計算**: 最終的な個人間清算金額の算出
- **分割シミュレーション**: リアルタイムでの分割結果プレビュー

### 2.5 共同編集機能

#### 2.5.1 リアルタイム同期
- **WebSocketサーバー**: Rustで実装した高性能WebSocketサーバー
- **同期対象データ**:
  - タイムライン情報の追加・編集・削除
  - 持ち物リストの変更
  - 予算情報の更新
  - LLMチャット履歴
- **同期間隔**: 即座（1秒以内の反映）

#### 2.5.2 競合解決
- **マージ方式**: 同一項目の同時編集時は差分をマージして統合
- **フォールバック処理**: マージが失敗した場合は最新のタイムスタンプを採用
- **楽観的ロック**: 編集開始時のバージョン管理
- **エラーハンドリング**: 競合発生時の適切な通知表示
- **差分表示**: 競合時に変更箇所をハイライト表示

#### 2.5.3 編集状態表示
- **アクティブユーザー表示**: 現在編集中のユーザー一覧
- **編集箇所の強調**: 他ユーザーが編集中の項目の視覚的表示
- **カーソル位置同期**: リアルタイムでの他ユーザーのカーソル位置表示

### 2.6 デザインテーマ機能

#### 2.6.1 テーマ種類
- **おしゃれ**: モダンでミニマルなデザイン
- **かわいい**: パステルカラーとポップなイラスト
- **レトロ**: ビンテージ風のカラーリングとフォント
- **シンプル**: 機能重視のクリーンなデザイン
- **カスタム**: ユーザー定義のカスタムテーマ（v2で実装予定）

#### 2.6.1.1 カスタムテーマ機能（将来実装）
- **カラーピッカー**: 直感的な色指定インターフェース
- **カラーパレット生成**: メインカラーから調和色の自動生成
- **プレビュー機能**: リアルタイムでのテーマ変更プレビュー
- **保存・共有**: カスタムテーマの保存と他ユーザーとの共有

#### 2.6.2 テーマ構成要素
- **カラーパレット**: プライマリ、セカンダリ、アクセントカラー
- **フォント**: タイトル用・本文用フォントファミリー
- **アイコンセット**: テーマに合わせたアイコンデザイン
- **背景パターン**: テーマ別の背景デザイン
- **アニメーション**: UI操作時のトランジション効果

#### 2.6.3 テーマ切り替え
- **動的変更**: ページリロード不要での即座のテーマ変更
- **設定保存**: LocalStorageでのテーマ設定永続化
- **共有設定**: しおりごとのデフォルトテーマ設定

### 2.7 LLM連携機能

#### 2.7.1 チャットボット機能
- **対応LLMプロバイダー**:
  - OpenAI ChatGPT (GPT-4, GPT-3.5-turbo)
  - Google Gemini (Gemini Pro)
  - Anthropic Claude (Claude-3)
- **プロバイダー切り替え**: ユーザーによる任意選択
- **API設定**: ユーザー自身のAPIキー使用

#### 2.7.2 旅行相談機能
- **相談対応範囲**:
  - 目的地の観光情報・おすすめスポット
  - 交通手段・ルートの提案
  - 宿泊施設の推薦
  - 地域の食事・グルメ情報
  - 気候・服装のアドバイス
  - 予算計画の相談
- **コンテキスト保持**: 会話履歴の保持と参照
- **多言語対応**: 日本語・英語での対話

#### 2.7.3 予定自動生成機能
- **自然言語入力**: 「明日の午前中に浅草周辺を観光したい」等の入力
- **予定項目生成**: 会話内容からタイムライン項目の自動生成
- **確認プロセス**: 自動生成項目のユーザー確認・承認
- **既存予定連携**: 既存のタイムラインとの整合性チェック

#### 2.7.4 APIキー管理
- **環境変数設定**: サーバー側で各LLMプロバイダーのAPIキーを環境変数として管理
- **プロバイダー別設定**:
  - `OPENAI_API_KEY`: OpenAI ChatGPT用
  - `GOOGLE_API_KEY`: Google Gemini用
  - `ANTHROPIC_API_KEY`: Anthropic Claude用
- **フォールバック機能**: 主要プロバイダーが利用不可の場合の代替プロバイダー自動切り替え

---

## 3. 技術仕様詳細

### 3.1 システム構成

#### 3.1.1 フロントエンド (SvelteKit)
- **フレームワーク**: SvelteKit (最新安定版)
- **言語**: TypeScript
- **状態管理**: Svelte stores + Context API
- **UIコンポーネント**: カスタムコンポーネント中心
- **スタイリング**: CSS Custom Properties + SCSS
- **ビルドツール**: Vite
- **パッケージマネージャー**: pnpm

#### 3.1.2 バックエンド (Rust)
- **フレームワーク**: Axum (0.7系)
- **WebAssembly**: wasm-pack + wasm-bindgen
- **非同期ランタイム**: tokio
- **HTTPクライアント**: reqwest
- **WebSocketライブラリ**: tokio-tungstenite
- **シリアライゼーション**: serde + serde_json
- **クロスオリジン**: tower-cors

#### 3.1.3 インフラストラクチャ
- **実行環境**: Cloudflare Workers
- **データベース**: Cloudflare D1 (SQLite ベース)
- **ストレージ**: Cloudflare KV (セッション・キャッシュ)
- **CDN**: Cloudflare CDN
- **ドメイン**: Cloudflare DNS
- **SSL**: Cloudflare SSL/TLS

### 3.2 データベース設計

#### 3.2.1 テーブル構造

##### itineraries テーブル
```sql
CREATE TABLE itineraries (
    id TEXT PRIMARY KEY,
    title TEXT NOT NULL,
    description TEXT,
    edit_password_hash TEXT,
    theme TEXT DEFAULT 'simple',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

##### timeline_items テーブル
```sql
CREATE TABLE timeline_items (
    id TEXT PRIMARY KEY,
    itinerary_id TEXT NOT NULL,
    title TEXT NOT NULL,
    description TEXT,
    location_name TEXT,
    location_address TEXT,
    location_lat REAL,
    location_lng REAL,
    start_datetime DATETIME,
    end_datetime DATETIME,
    budget_amount INTEGER,
    memo TEXT,
    sort_order INTEGER,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (itinerary_id) REFERENCES itineraries (id)
);
```

##### packing_items テーブル
```sql
CREATE TABLE packing_items (
    id TEXT PRIMARY KEY,
    itinerary_id TEXT NOT NULL,
    item_name TEXT NOT NULL,
    category TEXT,
    quantity INTEGER DEFAULT 1,
    is_checked BOOLEAN DEFAULT FALSE,
    memo TEXT,
    assignee TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (itinerary_id) REFERENCES itineraries (id)
);
```

##### budget_items テーブル
```sql
CREATE TABLE budget_items (
    id TEXT PRIMARY KEY,
    itinerary_id TEXT NOT NULL,
    category TEXT NOT NULL,
    item_name TEXT NOT NULL,
    planned_amount INTEGER,
    actual_amount INTEGER,
    payer TEXT,
    split_method TEXT DEFAULT 'equal',
    expense_date DATE,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (itinerary_id) REFERENCES itineraries (id)
);
```

##### chat_messages テーブル
```sql
CREATE TABLE chat_messages (
    id TEXT PRIMARY KEY,
    itinerary_id TEXT NOT NULL,
    role TEXT NOT NULL CHECK (role IN ('user', 'assistant')),
    content TEXT NOT NULL,
    llm_provider TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (itinerary_id) REFERENCES itineraries (id)
);
```

#### 3.2.2 インデックス設計
```sql
CREATE INDEX idx_timeline_items_itinerary_id ON timeline_items (itinerary_id);
CREATE INDEX idx_timeline_items_start_datetime ON timeline_items (start_datetime);
CREATE INDEX idx_packing_items_itinerary_id ON packing_items (itinerary_id);
CREATE INDEX idx_budget_items_itinerary_id ON budget_items (itinerary_id);
CREATE INDEX idx_chat_messages_itinerary_id ON chat_messages (itinerary_id);
```

### 3.3 API設計

#### 3.3.1 RESTful API エンドポイント

##### しおり管理
- `POST /api/itineraries` - しおり新規作成
- `GET /api/itineraries/{id}` - しおり詳細取得
- `PUT /api/itineraries/{id}` - しおり情報更新
- `DELETE /api/itineraries/{id}` - しおり削除

##### タイムライン管理
- `GET /api/itineraries/{id}/timeline` - タイムライン取得
- `POST /api/itineraries/{id}/timeline` - 予定項目追加
- `PUT /api/itineraries/{id}/timeline/{item_id}` - 予定項目更新
- `DELETE /api/itineraries/{id}/timeline/{item_id}` - 予定項目削除

##### 持ち物リスト管理
- `GET /api/itineraries/{id}/packing` - 持ち物リスト取得
- `POST /api/itineraries/{id}/packing` - 持ち物追加
- `PUT /api/itineraries/{id}/packing/{item_id}` - 持ち物更新
- `DELETE /api/itineraries/{id}/packing/{item_id}` - 持ち物削除

##### 予算管理
- `GET /api/itineraries/{id}/budget` - 予算情報取得
- `POST /api/itineraries/{id}/budget` - 予算項目追加
- `PUT /api/itineraries/{id}/budget/{item_id}` - 予算項目更新
- `DELETE /api/itineraries/{id}/budget/{item_id}` - 予算項目削除

##### LLMチャット
- `GET /api/itineraries/{id}/chat` - チャット履歴取得
- `POST /api/itineraries/{id}/chat` - メッセージ送信

#### 3.3.2 WebSocket API

##### 接続・認証
- 接続エンドポイント: `wss://api.axi-itinerary.app/ws/{itinerary_id}`
- 認証方式: URLパラメータでの編集パスワード送信

##### メッセージフォーマット
```typescript
interface WebSocketMessage {
  type: 'timeline_update' | 'packing_update' | 'budget_update' | 'chat_update';
  action: 'create' | 'update' | 'delete';
  data: any;
  timestamp: string;
  user_id: string;
}
```

### 3.4 セキュリティ仕様

#### 3.4.1 認証・認可
- **編集認証**: bcrypt でハッシュ化したパスワードによる認証
- **セッション管理**: JWT トークンベースのセッション管理
- **CSRF対策**: SameSite Cookie + CSRF トークン

#### 3.4.2 データ保護
- **入力検証**: 全ての入力データに対する厳格なバリデーション
- **SQLインジェクション対策**: プリペアドステートメント使用
- **XSS対策**: HTML エスケープ処理

#### 3.4.3 外部API連携
- **APIキー管理**: ユーザー側でのAPIキー管理（サーバー側保存なし）
- **レート制限**: LLM API呼び出し回数の制限
- **エラーハンドリング**: API障害時の適切な処理

---

## 4. ファイル構造とコンポーネント設計

### 4.1 プロジェクト全体構造
```
AxI-itinerary/
├── frontend/                # SvelteKit フロントエンド
│   ├── src/
│   │   ├── lib/            # 共通ライブラリ
│   │   ├── routes/         # ページルート
│   │   └── components/     # UIコンポーネント
│   ├── static/            # 静的ファイル
│   └── package.json       # 依存関係
├── backend/               # Rust WebAssembly バックエンド
│   ├── src/
│   │   ├── api/           # API ハンドラー
│   │   ├── websocket/     # WebSocket サーバー
│   │   ├── models/        # データモデル
│   │   └── database/      # DB操作
│   └── Cargo.toml         # Rust 依存関係
├── docs/                  # ドキュメント
└── migrations/           # DB マイグレーション
```

### 4.2 フロントエンド構造詳細

#### 4.2.1 コアライブラリ (/frontend/src/lib/)
| ファイル | 役割 | 説明 |
|---|---|---|
| `database.ts` | DB接続管理 | Cloudflare D1との通信ラッパー |
| `websocket.ts` | WebSocket管理 | リアルタイム通信の統一インターフェース |
| `llm-client.ts` | LLM統合 | 複数LLMプロバイダーとの通信ライブラリ |
| `auth.ts` | 認証管理 | 編集パスワード認証とセッション管理 |
| `utils.ts` | ユーティリティ | 共通関数（UUID生成、日付操作等） |

#### 4.2.2 状態管理 (/frontend/src/lib/stores/)
| ファイル | 役割 | 説明 |
|---|---|---|
| `itinerary.ts` | しおり状態 | しおり情報とメタデータの管理 |
| `timeline.ts` | タイムライン状態 | 予定項目の CRUD 操作と状態管理 |
| `packing.ts` | 持ち物状態 | 持ち物リストの管理と進捗追跡 |
| `budget.ts` | 予算状態 | 予算データと計算結果の管理 |
| `chat.ts` | チャット状態 | LLM会話履歴とメッセージ管理 |
| `theme.ts` | テーマ状態 | デザインテーマの切り替えと保存 |
| `realtime.ts` | リアルタイム状態 | WebSocket接続と同期状態の管理 |

#### 4.2.3 UIコンポーネント (/frontend/src/lib/components/)

##### 共通コンポーネント
| ファイル | 役割 | 説明 |
|---|---|---|
| `Layout.svelte` | 全体レイアウト | ヘッダー、サイドバー、メインエリア |
| `Header.svelte` | ヘッダー | ナビゲーション、テーマ切り替え |
| `LoadingSpinner.svelte` | ローディング | 非同期処理中の表示 |
| `ErrorMessage.svelte` | エラー表示 | エラー状態の統一表示 |
| `Modal.svelte` | モーダル | 汎用モーダルダイアログ |

##### 機能別コンポーネント
| ファイル | 役割 | 説明 |
|---|---|---|
| `ItineraryHeader.svelte` | しおりヘッダー | タイトル、説明、編集モード切り替え |
| `Timeline/` | タイムライン機能 | 予定管理関連コンポーネント群 |
| `├─ TimelineView.svelte` | タイムライン表示 | 全体のタイムライン表示コンテナ |
| `├─ TimelineItem.svelte` | 予定項目 | 個別予定の表示・編集 |
| `├─ TimelineForm.svelte` | 予定フォーム | 新規・編集フォーム |
| `├─ DateTimePicker.svelte` | 日時選択 | 日時入力コンポーネント |
| `PackingList/` | 持ち物リスト機能 | 持ち物管理関連コンポーネント群 |
| `├─ PackingView.svelte` | 持ち物一覧 | 持ち物リスト表示コンテナ |
| `├─ PackingItem.svelte` | 持ち物項目 | 個別アイテムの表示・編集 |
| `├─ PackingForm.svelte` | 持ち物フォーム | 新規・編集フォーム |
| `├─ CategoryFilter.svelte` | カテゴリフィルタ | カテゴリ別フィルタリング |
| `Budget/` | 予算管理機能 | 予算計算関連コンポーネント群 |
| `├─ BudgetView.svelte` | 予算一覧 | 予算情報表示コンテナ |
| `├─ BudgetItem.svelte` | 予算項目 | 個別予算の表示・編集 |
| `├─ BudgetForm.svelte` | 予算フォーム | 新規・編集フォーム |
| `├─ SplitCalculator.svelte` | 分割計算 | 費用分割の計算・表示 |
| `Chat/` | チャット機能 | LLM対話関連コンポーネント群 |
| `├─ ChatView.svelte` | チャット表示 | 会話履歴表示コンテナ |
| `├─ ChatMessage.svelte` | メッセージ | 個別メッセージの表示 |
| `├─ ChatInput.svelte` | 入力フォーム | メッセージ入力フォーム |
| `├─ LLMSelector.svelte` | LLM選択 | プロバイダー選択UI |
| `Theme/` | テーマ機能 | デザインテーマ関連コンポーネント群 |
| `├─ ThemeSelector.svelte` | テーマ選択 | テーマ切り替えUI |
| `├─ ColorPicker.svelte` | カラーピッカー | カスタムテーマ用色選択 |

#### 4.2.4 ページルート (/frontend/src/routes/)
| ファイル | 役割 | 説明 |
|---|---|---|
| `+layout.svelte` | 共通レイアウト | 全ページ共通のレイアウト設定 |
| `+page.svelte` | トップページ | しおり新規作成とアクセス |
| `itinerary/[id]/+page.svelte` | しおり詳細 | メインのしおり表示・編集ページ |
| `api/+server.ts` | API ルート | SvelteKit API エンドポイント |

### 4.3 バックエンド構造詳細

#### 4.3.1 APIハンドラー (/backend/src/api/)
| ファイル | 役割 | 説明 |
|---|---|---|
| `mod.rs` | API モジュール | API関連の統合モジュール |
| `itinerary.rs` | しおりAPI | しおりのCRUD操作 |
| `timeline.rs` | タイムラインAPI | 予定項目のCRUD操作 |
| `packing.rs` | 持ち物API | 持ち物リストのCRUD操作 |
| `budget.rs` | 予算API | 予算情報のCRUD操作 |
| `chat.rs` | チャットAPI | LLM対話とメッセージ管理 |
| `auth.rs` | 認証API | パスワード認証とセッション管理 |

#### 4.3.2 WebSocketサーバー (/backend/src/websocket/)
| ファイル | 役割 | 説明 |
|---|---|---|
| `mod.rs` | WebSocket モジュール | WebSocket関連の統合モジュール |
| `server.rs` | サーバー管理 | WebSocket接続とルーム管理 |
| `handlers.rs` | メッセージハンドラー | 受信メッセージの処理ロジック |
| `broadcaster.rs` | ブロードキャスト | 接続クライアントへのメッセージ配信 |

#### 4.3.3 データモデル (/backend/src/models/)
| ファイル | 役割 | 説明 |
|---|---|---|
| `mod.rs` | モデル統合 | 全データモデルの統合エクスポート |
| `itinerary.rs` | しおりモデル | しおりの構造体と操作定義 |
| `timeline.rs` | タイムラインモデル | 予定項目の構造体と操作定義 |
| `packing.rs` | 持ち物モデル | 持ち物の構造体と操作定義 |
| `budget.rs` | 予算モデル | 予算の構造体と操作定義 |
| `chat.rs` | チャットモデル | メッセージの構造体と操作定義 |

#### 4.3.4 データベース操作 (/backend/src/database/)
| ファイル | 役割 | 説明 |
|---|---|---|
| `mod.rs` | DB統合モジュール | データベース関連の統合モジュール |
| `connection.rs` | 接続管理 | Cloudflare D1接続の管理 |
| `migrations.rs` | マイグレーション | スキーマ変更の管理 |
| `queries.rs` | クエリ定義 | 共通SQLクエリの定義 |

---

| 対応するフォルダ | 対応するファイル | 修正内容の概要 |
|---|---|---|
| `/` | `package.json` | SvelteKit プロジェクトの初期化、依存関係設定 |
| `/src` | `app.html` | HTML テンプレート作成、メタタグ設定 |
| `/src/lib` | `database.ts` | Cloudflare D1 データベース接続設定 |
| `/src/lib` | `websocket.ts` | WebSocket クライアント実装 |
| `/src/lib` | `llm.ts` | LLM API 統合ライブラリ |
| `/src/lib/stores` | `itinerary.ts` | しおり状態管理 Store |
| `/src/lib/stores` | `theme.ts` | テーマ状態管理 Store |
| `/src/lib/components` | `ItineraryHeader.svelte` | しおりヘッダーコンポーネント |
| `/src/lib/components` | `Timeline.svelte` | タイムライン表示コンポーネント |
| `/src/lib/components` | `TimelineItem.svelte` | 個別予定項目コンポーネント |
| `/src/lib/components` | `PackingList.svelte` | 持ち物リストコンポーネント |
| `/src/lib/components` | `BudgetCalculator.svelte` | 予算計算コンポーネント |
| `/src/lib/components` | `ChatBot.svelte` | LLM チャットボットコンポーネント |
| `/src/lib/components` | `ThemeSelector.svelte` | テーマ選択コンポーネント |
| `/src/routes` | `+layout.svelte` | 共通レイアウト設定 |
| `/src/routes` | `+page.svelte` | トップページ（しおり作成） |
| `/src/routes/itinerary/[id]` | `+page.svelte` | しおり表示・編集ページ |
| `/src/routes/api` | `+server.ts` | API ルート定義 |
| `/backend` | `Cargo.toml` | Rust プロジェクト設定 |
| `/backend/src` | `main.rs` | Rust WebAssembly エントリーポイント |
| `/backend/src` | `api/mod.rs` | API ハンドラー定義 |
| `/backend/src` | `websocket/mod.rs` | WebSocket サーバー実装 |
| `/backend/src` | `models/mod.rs` | データモデル定義 |
| `/backend/src` | `database/mod.rs` | データベース操作ロジック |
| `/static` | `global.css` | グローバルスタイル定義 |
| `/static/themes` | `*.css` | テーマ別スタイルシート |
| `/` | `wrangler.toml` | Cloudflare Workers 設定 |
| `/` | `migrations/` | データベースマイグレーションファイル |

---

---

## 5. 開発TODOリスト

### 5.1 フェーズ1: 基盤構築
- [ ] **プロジェクト初期化**
  - [ ] SvelteKit プロジェクト作成
  - [ ] Rust WebAssembly プロジェクト作成
  - [ ] Cloudflare Workers 環境設定
  - [ ] 依存関係とビルドシステム構築

- [ ] **データベース設計・構築**
  - [ ] Cloudflare D1 データベース作成
  - [ ] テーブルスキーマ作成
  - [ ] インデックス設定
  - [ ] マイグレーションシステム構築

- [ ] **認証システム**
  - [ ] 編集パスワード認証機能
  - [ ] セッション管理機能
  - [ ] セキュリティ対策実装

### 5.2 フェーズ2: コア機能開発
- [ ] **しおり管理機能**
  - [ ] しおり新規作成API
  - [ ] しおり詳細取得API
  - [ ] しおり更新・削除API
  - [ ] フロントエンド画面

- [ ] **タイムライン機能**
  - [ ] 予定項目CRUD API
  - [ ] タイムライン表示コンポーネント
  - [ ] 予定編集フォーム
  - [ ] ドラッグ&ドロップ並び替え

- [ ] **持ち物リスト機能**
  - [ ] 持ち物CRUD API
  - [ ] 持ち物一覧表示コンポーネント
  - [ ] カテゴリ分類機能
  - [ ] 進捗追跡機能

- [ ] **予算管理機能**
  - [ ] 予算CRUD API
  - [ ] 予算表示・編集コンポーネント
  - [ ] 分割計算ロジック
  - [ ] 清算機能

### 5.3 フェーズ3: 高度機能開発
- [ ] **リアルタイム同期**
  - [ ] WebSocket サーバー実装
  - [ ] クライアント側WebSocket管理
  - [ ] 競合解決システム
  - [ ] リアルタイム状態表示

- [ ] **LLM連携機能**
  - [ ] 複数LLMプロバイダー対応
  - [ ] チャット機能実装
  - [ ] 予定自動生成機能
  - [ ] 自然言語処理

- [ ] **テーマシステム**
  - [ ] 基本テーマ実装
  - [ ] テーマ切り替え機能
  - [ ] カスタムテーマ機能（将来）

### 5.4 フェーズ4: 最適化・デプロイ
- [ ] **パフォーマンス最適化**
  - [ ] WebAssembly最適化
  - [ ] フロントエンド最適化
  - [ ] データベースクエリ最適化

- [ ] **テスト・品質保証**
  - [ ] ユニットテスト作成
  - [ ] 統合テスト作成
  - [ ] E2Eテスト作成
  - [ ] セキュリティテスト

- [ ] **デプロイメント**
  - [ ] Cloudflare Workers デプロイ設定
  - [ ] Cloudflare Pages デプロイ設定
  - [ ] CI/CD パイプライン構築
  - [ ] 本番環境設定

---

## 6. 情報源とリファレンス

### 6.1 プライマリ情報源
- **要件定義書**: `/docs/prd.md` - プロジェクトの基本要件と技術要件
- **設計ドキュメント**: `/docs/prd/v0.md` - 本ドキュメント（詳細設計）

### 6.2 技術リファレンス
- **SvelteKit**: https://kit.svelte.dev/ - フロントエンドフレームワーク
- **Rust WebAssembly**: https://rustwasm.github.io/ - バックエンド実装
- **Cloudflare Workers**: https://developers.cloudflare.com/workers/ - 実行環境
- **Cloudflare D1**: https://developers.cloudflare.com/d1/ - データベース
- **Axum**: https://docs.rs/axum/ - Rust Webフレームワーク

### 6.3 設計・実装ファイルパス
#### 作成予定ファイル
- **フロントエンド設定**: `/frontend/package.json`, `/frontend/svelte.config.js`
- **バックエンド設定**: `/backend/Cargo.toml`, `/backend/src/main.rs`
- **インフラ設定**: `/wrangler.toml`, `/migrations/`
- **ドキュメント**: `/docs/api.md`, `/docs/deployment.md`

#### 環境設定ファイル
- **環境変数**: `.env.example` - 環境変数テンプレート
- **Cloudflare設定**: `wrangler.toml` - Workers デプロイ設定
- **ビルド設定**: `/frontend/vite.config.js`, `/backend/Cargo.toml`

---

## 7. 実装計画テーブル

| 対応するフォルダ | 対応するファイル | 修正内容の概要 |
|---|---|---|
| **プロジェクト基盤** |
| `/` | `package.json` | プロジェクト全体の依存関係とスクリプト定義 |
| `/` | `wrangler.toml` | Cloudflare Workers デプロイ設定 |
| `/` | `.env.example` | 環境変数テンプレート（LLM APIキー等） |
| **フロントエンド - 設定** |
| `/frontend` | `package.json` | SvelteKit と TypeScript 依存関係設定 |
| `/frontend` | `svelte.config.js` | SvelteKit 設定（アダプター、プリプロセッサ） |
| `/frontend` | `vite.config.js` | Vite ビルド設定とプラグイン設定 |
| `/frontend/src` | `app.html` | HTML テンプレート、メタタグ、CDN設定 |
| **フロントエンド - コアライブラリ** |
| `/frontend/src/lib` | `database.ts` | Cloudflare D1 接続と操作のラッパー |
| `/frontend/src/lib` | `websocket.ts` | WebSocket 接続管理とイベントハンドリング |
| `/frontend/src/lib` | `llm-client.ts` | 複数LLMプロバイダーとの統合ライブラリ |
| `/frontend/src/lib` | `auth.ts` | 編集パスワード認証とセッション管理 |
| `/frontend/src/lib` | `utils.ts` | UUID生成、日付操作、バリデーション関数 |
| **フロントエンド - 状態管理** |
| `/frontend/src/lib/stores` | `itinerary.ts` | しおり情報の状態管理 |
| `/frontend/src/lib/stores` | `timeline.ts` | タイムライン予定の状態管理 |
| `/frontend/src/lib/stores` | `packing.ts` | 持ち物リストの状態管理 |
| `/frontend/src/lib/stores` | `budget.ts` | 予算・費用計算の状態管理 |
| `/frontend/src/lib/stores` | `chat.ts` | LLMチャット履歴の状態管理 |
| `/frontend/src/lib/stores` | `theme.ts` | デザインテーマの状態管理 |
| `/frontend/src/lib/stores` | `realtime.ts` | リアルタイム同期の状態管理 |
| **フロントエンド - UIコンポーネント** |
| `/frontend/src/lib/components` | `Layout.svelte` | 全体レイアウト（ヘッダー、サイドバー、メイン） |
| `/frontend/src/lib/components` | `Header.svelte` | ヘッダーナビゲーションとテーマ切り替え |
| `/frontend/src/lib/components` | `LoadingSpinner.svelte` | ローディング表示の統一コンポーネント |
| `/frontend/src/lib/components` | `ErrorMessage.svelte` | エラー表示の統一コンポーネント |
| `/frontend/src/lib/components` | `Modal.svelte` | 汎用モーダルダイアログ |
| `/frontend/src/lib/components` | `ItineraryHeader.svelte` | しおりタイトル・説明・編集モード |
| **フロントエンド - 機能別コンポーネント** |
| `/frontend/src/lib/components/Timeline` | `TimelineView.svelte` | タイムライン全体表示コンテナ |
| `/frontend/src/lib/components/Timeline` | `TimelineItem.svelte` | 個別予定項目の表示・編集 |
| `/frontend/src/lib/components/Timeline` | `TimelineForm.svelte` | 予定新規作成・編集フォーム |
| `/frontend/src/lib/components/Timeline` | `DateTimePicker.svelte` | 日時選択入力コンポーネント |
| `/frontend/src/lib/components/PackingList` | `PackingView.svelte` | 持ち物リスト表示コンテナ |
| `/frontend/src/lib/components/PackingList` | `PackingItem.svelte` | 個別持ち物項目の表示・編集 |
| `/frontend/src/lib/components/PackingList` | `PackingForm.svelte` | 持ち物新規追加・編集フォーム |
| `/frontend/src/lib/components/PackingList` | `CategoryFilter.svelte` | カテゴリ別フィルタリング機能 |
| `/frontend/src/lib/components/Budget` | `BudgetView.svelte` | 予算情報表示コンテナ |
| `/frontend/src/lib/components/Budget` | `BudgetItem.svelte` | 個別予算項目の表示・編集 |
| `/frontend/src/lib/components/Budget` | `BudgetForm.svelte` | 予算新規追加・編集フォーム |
| `/frontend/src/lib/components/Budget` | `SplitCalculator.svelte` | 費用分割計算とUI |
| `/frontend/src/lib/components/Chat` | `ChatView.svelte` | LLMチャット表示コンテナ |
| `/frontend/src/lib/components/Chat` | `ChatMessage.svelte` | 個別メッセージ表示コンポーネント |
| `/frontend/src/lib/components/Chat` | `ChatInput.svelte` | メッセージ入力フォーム |
| `/frontend/src/lib/components/Chat` | `LLMSelector.svelte` | LLMプロバイダー選択UI |
| `/frontend/src/lib/components/Theme` | `ThemeSelector.svelte` | テーマ切り替えUI |
| `/frontend/src/lib/components/Theme` | `ColorPicker.svelte` | カスタムテーマ用カラーピッカー |
| **フロントエンド - ページルート** |
| `/frontend/src/routes` | `+layout.svelte` | 全ページ共通レイアウト設定 |
| `/frontend/src/routes` | `+page.svelte` | トップページ（しおり作成・アクセス） |
| `/frontend/src/routes/itinerary/[id]` | `+page.svelte` | しおり詳細・編集メインページ |
| `/frontend/src/routes/api` | `+server.ts` | SvelteKit API エンドポイント定義 |
| **バックエンド - 設定** |
| `/backend` | `Cargo.toml` | Rust プロジェクト設定と依存関係 |
| `/backend/src` | `main.rs` | WebAssembly エントリーポイント |
| `/backend/src` | `lib.rs` | ライブラリクレート設定 |
| **バックエンド - APIハンドラー** |
| `/backend/src/api` | `mod.rs` | API モジュール統合 |
| `/backend/src/api` | `itinerary.rs` | しおりCRUD API ハンドラー |
| `/backend/src/api` | `timeline.rs` | タイムライン CRUD API ハンドラー |
| `/backend/src/api` | `packing.rs` | 持ち物リスト CRUD API ハンドラー |
| `/backend/src/api` | `budget.rs` | 予算管理 CRUD API ハンドラー |
| `/backend/src/api` | `chat.rs` | LLMチャット API ハンドラー |
| `/backend/src/api` | `auth.rs` | 認証・セッション管理 API |
| **バックエンド - WebSocket** |
| `/backend/src/websocket` | `mod.rs` | WebSocket モジュール統合 |
| `/backend/src/websocket` | `server.rs` | WebSocket サーバー接続管理 |
| `/backend/src/websocket` | `handlers.rs` | メッセージハンドラーとルーティング |
| `/backend/src/websocket` | `broadcaster.rs` | クライアントへのブロードキャスト |
| **バックエンド - データ層** |
| `/backend/src/models` | `mod.rs` | データモデル統合 |
| `/backend/src/models` | `itinerary.rs` | しおりデータ構造体と操作 |
| `/backend/src/models` | `timeline.rs` | タイムラインデータ構造体と操作 |
| `/backend/src/models` | `packing.rs` | 持ち物データ構造体と操作 |
| `/backend/src/models` | `budget.rs` | 予算データ構造体と操作 |
| `/backend/src/models` | `chat.rs` | チャットデータ構造体と操作 |
| `/backend/src/database` | `mod.rs` | データベース操作統合 |
| `/backend/src/database` | `connection.rs` | Cloudflare D1 接続管理 |
| `/backend/src/database` | `queries.rs` | 共通SQLクエリ定義 |
| `/backend/src/database` | `migrations.rs` | スキーママイグレーション管理 |
| **スタイル・テーマ** |
| `/frontend/static` | `global.css` | グローバルスタイル設定 |
| `/frontend/static/themes` | `simple.css` | シンプルテーマスタイル |
| `/frontend/static/themes` | `modern.css` | おしゃれテーマスタイル |
| `/frontend/static/themes` | `cute.css` | かわいいテーマスタイル |
| `/frontend/static/themes` | `retro.css` | レトロテーマスタイル |
| **データベース** |
| `/migrations` | `001_create_tables.sql` | 基本テーブル作成マイグレーション |
| `/migrations` | `002_create_indexes.sql` | インデックス作成マイグレーション |

この実装計画テーブルに基づいて、エンジニアは各ファイルの具体的な実装を順次進めることができます。各ファイルの役割と実装内容が明確に定義されているため、AI支援での実装も効率的に行えます。
